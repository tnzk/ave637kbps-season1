#!/usr/bin/env ruby

$: << ENV['PWD']
require 'hakorb'
require 'sdl'

abort 'Specify a map name like this: ./sim map001.txt' if ARGV.size == 0

map_name = ARGV[0]

key_server = 0
old_key_server = 0
UP    = 0x0001
RIGHT = 0x0002
DOWN  = 0x0004
LEFT  = 0x0008

SDL.init( SDL::INIT_VIDEO ) 
screen = SDL.setVideoMode( 640, 480, 16, SDL::SWSURFACE ) 

image = SDL::Surface.loadBMP( 'resources/tnzk.bmp' )
#image.setColorKey( SDL::SRCCOLORKEY, image.getPixel(0,0) ) 
#image = image.displayFormat 

chips = [ SDL::Surface.loadBMP( 'resources/g001.bmp' ),
          SDL::Surface.loadBMP( 'resources/g002.bmp' ),
          SDL::Surface.loadBMP( 'resources/g003.bmp' )]

w = World.new(10,10,10)
w.load(map_name)

z = 0
loop do
  while event = SDL::Event2.poll 
    case event 
    when SDL::Event2::Quit 
      exit 
    end
  end

  screen.fillRect( 0, 0, 640, 480, [ 0, 0, 0 ] )
  SDL::Key.scan
  key_server |=  UP       if SDL::Key.press?(SDL::Key::UP)
  key_server &= ~UP   unless SDL::Key.press?(SDL::Key::UP)
  key_server |=  DOWN     if SDL::Key.press?(SDL::Key::DOWN)
  key_server &= ~DOWN unless SDL::Key.press?(SDL::Key::DOWN)

  z += 1 if (key_server & UP)   != 0 && (old_key_server & UP)   == 0
  z -= 1 if (key_server & DOWN) != 0 && (old_key_server & DOWN) == 0
  z = 0 if z < 0
  z = w.depth - 1if z >= w.depth

  12.times do |y|
    12.times do |x|
      if w[x,y,z]
        img = chips[w[x,y,z].chip]
        screen.put( img, x * 40, y * 40 )
      end
    end
  end
  screen.updateRect( 0, 0, 0, 0 )
  old_key_server = key_server

end
